<?php

/**
 * Implements hook_views_plugins_style_alter().
 *
 * This replaces the core DefaultSummary style plug-in with our own.
 *
 * @param array $plugins
 *   An array of all the existing plugin definitions, passed by reference.
 */
function ambientimpact_views_views_plugins_style_alter(array &$plugins): void {
  if ($plugins['default_summary']['class'] ===
      'Drupal\\views\\Plugin\\views\\style\\DefaultSummary') {
    $plugins['default_summary']['class'] =
      'Drupal\\ambientimpact_views\\Plugin\\views\\style\\DefaultSummary';
  }
}

/**
 * Prepares variables for views summary templates.
 *
 * This rewrites the summary URLs generated by Views so that date arguments are
 * split by year/month/day as specified by the 'separate_date_arguments' option.
 *
 * Default template: views-view-summary.html.twig.
 *
 * @param array $variables
 *   An associative array containing:
 *   - view: A ViewExecutable object.
 *   - rows: The raw row data.
 *
 * @see template_preprocess_views_view_summary()
 *   URLs are generated here.
 *
 * @see \Drupal\ambientimpact_views\Plugin\views\style\DefaultSummary
 *   Defines the 'separate_date_arguments' option and provides the form
 *   elements.
 *
 * @see https://www.drupal.org/project/date/issues/1153052
 *   Discussion of splitting year/month/day components in date URLs for Drupal 6
 *   and 7.
 */
function ambientimpact_views_preprocess_views_view_summary(
  array &$variables
): void {
  if (!$variables['options']['separate_date_arguments']) {
    return;
  }

  foreach ($variables['rows'] as $id => $row) {
    if (
      !isset($row->created_fulldate) &&
      !isset($row->created_year_month)
    ) {
      continue;
    }

    // Grab the original date without slashes.
    if (isset($row->created_fulldate)) {
      $originalDate = $row->created_fulldate;
    } else if (isset($row->created_year_month)) {
      $originalDate = $row->created_year_month;
    }

    $urlSplit = explode('/', $row->url);

    $dateIndex = array_search($originalDate, $urlSplit);

    // Skip if the date without slashes isn't found in the split URL array.
    if ($dateIndex === false) {
      continue;
    }

    $newDate = $originalDate;

    $newDate = mb_substr($originalDate, 0, 4) . '/' .
      mb_substr($originalDate, 4, 2);

    // Add the day if using the 'created_fulldate'.
    if (mb_strlen($originalDate) === 8) {
      $newDate .= '/' . mb_substr($originalDate, 6);
    }

    // Replace the original date without slashes with the new one that is
    // separated by slashes.
    array_splice($urlSplit, $dateIndex, 1, [$newDate]);

    // Finaly, glue it all back together with slashes.
    $row->url = implode('/', $urlSplit);
  }
}
