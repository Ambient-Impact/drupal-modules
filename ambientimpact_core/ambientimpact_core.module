<?php

/**
 * Implements hook_element_info_alter().
 *
 * This attaches the toolbar component to the toolbar element.
 */
function ambientimpact_core_element_info_alter(array &$info) {
 if (isset($info['toolbar'])) {
   $info['toolbar']['#attached']['library'][] =
     'ambientimpact_core/component.toolbar';
 }
}

/**
 * Implements hook_field_formatter_info_alter().
 *
 * This replaces the 'video_embed_field_thumbnail' formatter class (if present)
 * with our own, which alters the video thumbnail render array to include a play
 * icon element. It doesn't seem possible currently to use this hook in a .theme
 * file, so we have to do this at the module level.
 *
 * This replaces the core 'image' formatter with our own, which extends the core
 * formatter with functionality that the PhotoSwipe component requires.
 *
 * @see \Drupal\ambientimpact_core\Plugin\Field\FieldFormatter\VideoEmbedFieldThumbnail
 *   Our thumbnail field formatter that extends the 'video_embed_field' one.
 *
 * @see \Drupal\ambientimpact_core\Plugin\Field\FieldFormatter\PhotoSwipeImageFormatter
 *   Our 'image' field formatter.
 */
function ambientimpact_core_field_formatter_info_alter(array &$info) {
  if (isset($info['video_embed_field_thumbnail'])) {
    $info['video_embed_field_thumbnail']['class'] =
      'Drupal\ambientimpact_core\Plugin\Field\FieldFormatter\VideoEmbedFieldThumbnail';
    $info['video_embed_field_thumbnail']['provider'] = 'ambientimpact_core';
  }

  if (
    isset($info['image']) &&
    // Only if this is the core formatter class to avoid breaking other modules.
    $info['image']['class'] ===
      'Drupal\image\Plugin\Field\FieldFormatter\ImageFormatter'
  ) {
    $info['image']['class'] =
      'Drupal\ambientimpact_core\Plugin\Field\FieldFormatter\PhotoSwipeImageFormatter';
    $info['image']['provider'] = 'ambientimpact_core';
  }
}

/**
 * Implements hook_field_formatter_third_party_settings_form().
 *
 * @see https://www.drupal.org/node/2130757
 *   Change record; describes the third party settings usage.
 *
 * @see https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Config%21Entity%21ThirdPartySettingsInterface.php/interface/ThirdPartySettingsInterface
 *   API documentation for third party settings on entities.
 */
function ambientimpact_core_field_formatter_third_party_settings_form(
  \Drupal\Core\Field\FormatterInterface $plugin,
  \Drupal\Core\Field\FieldDefinitionInterface $fieldDefinition,
  $viewMode,
  $form,
  \Drupal\Core\Form\FormStateInterface $formState
) {
  $elements = [];

  if ($plugin->getPluginId() === 'video_embed_field_thumbnail') {
    $elements['play_icon'] = [
      '#type'           => 'checkbox',
      '#title'          => t('Show provider/play icon'),
      '#description'    => t('If enabled, will overlay a provider-specific icon (e.g. YouTube) over the thumbnail or a generic play icon if no external provider is used.'),
      '#default_value'  =>
        $plugin->getThirdPartySetting('ambientimpact_core', 'play_icon'),
    ];
  }

  return $elements;
}

/**
 * Implements hook_field_formatter_settings_summary_alter().
 *
 * This displays a message on the video embed field thumbnail formatter summary
 * if the provider/play icon is shown over the thumbnail.
 *
 * @see https://www.drupal.org/node/2130757
 *   Change record; describes the third party settings usage.
 *
 * @see https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Config%21Entity%21ThirdPartySettingsInterface.php/interface/ThirdPartySettingsInterface
 *   API documentation for third party settings on entities.
 */
function ambientimpact_core_field_formatter_settings_summary_alter(
  &$summary, $context
) {
  if (
    $context['formatter']->getPluginId() === 'video_embed_field_thumbnail' &&
    // This is passed to us as a string ('1' or '0'), despite the schema
    // specifying it as boolean, likely because this is at the Form API stage
    // where checkbox values are treated as strings.
    (bool) $context['formatter']->getThirdPartySetting(
      'ambientimpact_core', 'play_icon'
    ) === true
  ) {
    $summary[] = t('Provider/play icon shown.');
  }
}
