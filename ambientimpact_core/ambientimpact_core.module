<?php

/**
 * Implements hook_page_attachments().
 *
 * This adds our general library which contains common and layout CSS.
 *
 * This outputs the framework and component JavaScript settings to
 * drupalSettings.AmbientImpact.
 */
function ambientimpact_core_page_attachments(array &$page) {
	$page['#attached']['library'][] = 'ambientimpact_core/core';

	$jsSettings = [
		'framework'	=> [
			'cache'		=> [
				'assetKey'	=>
					\Drupal::state()->get('system.css_js_query_string'),
			],
		],
		'components'	=>
			\Drupal::service('plugin.manager.ambientimpact_component')
				->getComponentJSSettings()
	];

	$page['#attached']['drupalSettings']['AmbientImpact'] = $jsSettings;
}

/**
 * Implements hook_library_info_build().
 *
 * This returns the libraries defined in individual Ambient.Impact Components,
 * as returned by the 'plugin.manager.ambientimpact_component' service.
 *
 * @see \Drupal\ambientimpact_core\ComponentPluginManager::getComponentLibraries()
 *   Returns the value returned by this method.
 *
 * @see https://www.drupal.org/docs/8/creating-custom-modules/adding-stylesheets-css-and-javascript-js-to-a-drupal-8-module#dynamic-css-js
 */
function ambientimpact_core_library_info_build() {
	return
		\Drupal::service('plugin.manager.ambientimpact_component')
			->getComponentLibraries();
}

/**
 * Implements hook_library_info_alter().
 *
 * This replaces Drupal core's Modernizr with our own. We implement all the
 * options core's does, plus others. Note that we only do this if the core
 * Modernizr path is used, so as not to replace another module's override.
 */
function ambientimpact_core_library_info_alter(&$libraries, $extension) {
	$moduleHandler		= \Drupal::service('module_handler');
	$coreModernizrPath	= 'assets/vendor/modernizr/modernizr.min.js';
	$ourModernizrPath	= '../' . $moduleHandler
		->getModule('ambientimpact_core')->getPath() . '/' . $coreModernizrPath;

	if (
		$extension === 'core' &&
		isset($libraries['modernizr']['js'][$coreModernizrPath])
	) {
		// Save the settings core's uses.
		$libraries['modernizr']['js'][$ourModernizrPath] =
			$libraries['modernizr']['js'][$coreModernizrPath];

		// Remove the core path.
		unset($libraries['modernizr']['js'][$coreModernizrPath]);

		// This is the version that Grunt Modernizr has pulled on 2019-03-02.
		// @todo Can this be read from the file?
		$libraries['modernizr']['version'] = 'v3.5.0';
	}
}

/**
 * Implements hook_element_info_alter().
 */
// function ambientimpact_core_element_info_alter(array &$info) {
// 	if (isset($info['toolbar'])) {
// 		$info['toolbar']['#attached']['library'][] =
// 			'ambientimpact_core/component.toolbar';
// 	}
// }
